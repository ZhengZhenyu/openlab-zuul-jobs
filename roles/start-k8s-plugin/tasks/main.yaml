- name: Start k8s plugin
  shell:
    cmd: |
      case '{{ zuul.job }}' in
          cloud-provider-openstack-acceptance-test-csi-cinder)
              ;;
          cloud-provider-openstack-acceptance-test-k8s-cinder)
              nohup ./cinder-provisioner \
                  --cloud-config /etc/kubernetes/cloud-config \
                  --kubeconfig /var/run/kubernetes/admin.kubeconfig \
                  --id cinder \
                  > '{{ ansible_user_dir }}/workspace/logs/kubernetes/cinder-provisioner.log' 2>&1 &
              ;;
          *)
              echo 'There is no plugin of this job "{{ zuul.job }}", exit 1'
              exit 1
              ;;
      esac

      # set up the config we need for kubectl to work
      "$kubectl" config set-cluster local --server=https://localhost:6443 --certificate-authority=/var/run/kubernetes/server-ca.crt
      "$kubectl" config set-credentials myself --client-key=/var/run/kubernetes/client-admin.key --client-certificate=/var/run/kubernetes/client-admin.crt
      "$kubectl" config set-context local --cluster=local --user=myself
      "$kubectl" config use-context local

      # Hack for RBAC for all for the new cloud-controller process, we need to do better than this
      "$kubectl" create clusterrolebinding --user system:serviceaccount:kube-system:default kube-system-cluster-admin-1 --clusterrole cluster-admin
      "$kubectl" create clusterrolebinding --user system:serviceaccount:kube-system:pvl-controller kube-system-cluster-admin-2 --clusterrole cluster-admin
      "$kubectl" create clusterrolebinding --user system:serviceaccount:kube-system:cloud-node-controller kube-system-cluster-admin-3 --clusterrole cluster-admin
      "$kubectl" create clusterrolebinding --user system:serviceaccount:kube-system:cloud-controller-manager kube-system-cluster-admin-4 --clusterrole cluster-admin
      "$kubectl" create clusterrolebinding --user system:serviceaccount:kube-system:shared-informers kube-system-cluster-admin-5 --clusterrole cluster-admin
      "$kubectl" create clusterrolebinding --user system:kube-controller-manager kube-system-cluster-admin-6 --clusterrole cluster-admin
    executable: /bin/bash
    chdir: '{{ zuul.project.src_dir }}'
  environment: '{{ golang_env }}'
